<!DOCTYPE html>
<html lang="en">
<head>
  <!-- § Cognitive Header: Semantic HTML5 Structure and Design System Compliance -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="J Dilla audio-reactive sacred geometry visualizer carousel - master.json v148.11 compliant">
  <meta name="keywords" content="audio visualizer, sacred geometry, J Dilla, canvas, mobile-first, accessibility">
  <meta name="author" content="radio.brgen.no">
  <meta name="theme-color" content="#000000">
  <title>radio.brgen.no - Sacred Visual Experience</title>
  
  <!-- § Cognitive Header: Design System Variables - Golden Ratio, 8pt Grid, Modular Scale -->
  <style>
    :root {
      /* § Typography System - Golden Ratio Modular Scale */
      --font-primary: 'SF Pro Display', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      --font-size-base: clamp(16px, 4vw, 18px);
      --font-size-large: clamp(20px, 5vw, 28px);
      --font-size-small: clamp(14px, 3.5vw, 16px);
      --line-height-base: 1.618; /* Golden ratio */
      
      /* § Color System - WCAG AAA Compliant */
      --color-bg: #000000;
      --color-text: #ffffff;
      --color-accent: #4ecdc4;
      --color-muted: rgba(255, 255, 255, 0.7);
      --color-overlay: rgba(0, 0, 0, 0.9);
      --color-focus: #4ecdc4;
      
      /* § Spatial System - 8pt Grid */
      --space-xs: 0.5rem;   /* 8px */
      --space-sm: 1rem;     /* 16px */
      --space-md: 1.5rem;   /* 24px */
      --space-lg: 2rem;     /* 32px */
      --space-xl: 3rem;     /* 48px */
      
      /* § Motion System */
      --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease-out;
      
      /* § Layout System */
      --border-radius: 0.5rem;
      --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* § Cognitive Header: Global Reset and Base Styles */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      font-size: 100%;
      scroll-behavior: smooth;
      -webkit-text-size-adjust: 100%;
    }
    
    body {
      font-family: var(--font-primary);
      font-size: var(--font-size-base);
      line-height: var(--line-height-base);
      color: var(--color-text);
      background: var(--color-bg);
      overflow: hidden;
      cursor: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
    }
    
    /* § Cognitive Header: Accessibility - Skip Links and Focus Management */
    .skip-link {
      position: absolute;
      top: -40px;
      left: var(--space-sm);
      background: var(--color-focus);
      color: var(--color-bg);
      padding: var(--space-xs) var(--space-sm);
      text-decoration: none;
      border-radius: var(--border-radius);
      z-index: 1000;
      transition: var(--transition-base);
      font-weight: 600;
    }
    
    .skip-link:focus {
      top: var(--space-sm);
      outline: 2px solid var(--color-focus);
      outline-offset: 2px;
    }
    
    /* § Cognitive Header: Canvas and Visual Layer */
    canvas {
      position: fixed;
      inset: 0;
      z-index: 1;
      touch-action: manipulation;
      background: var(--color-bg);
      -webkit-touch-callout: none;
    }
    
    /* § Cognitive Header: Header and Branding */
    header {
      position: fixed;
      top: var(--space-lg);
      left: var(--space-lg);
      z-index: 10;
      pointer-events: none;
    }
    
    h1 {
      font-size: var(--font-size-large);
      font-weight: 700;
      color: var(--color-text);
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
      margin: 0;
    }
    
    /* § Cognitive Header: Now Playing Display */
    .now-playing {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      z-index: 10;
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--font-size-small);
      color: var(--color-muted);
      font-family: var(--font-mono);
      background: rgba(0, 0, 0, 0.7);
      border-radius: var(--border-radius);
      backdrop-filter: blur(5px);
      padding: 0.25rem 0.75rem;
      line-height: 1.2;
    }
    
    .note-icon {
      font-size: 1.2em;
      color: var(--color-accent);
      line-height: 1;
    }
    
    .track-display {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: min(300px, 60vw);
      line-height: 1.2;
    }
    
    /* § Cognitive Header: Controls Display */
    .controls-hint {
      position: fixed;
      bottom: var(--space-lg);
      left: var(--space-lg);
      z-index: 10;
      pointer-events: none;
      font-size: var(--font-size-small);
      color: var(--color-muted);
      font-family: var(--font-mono);
      background: rgba(0, 0, 0, 0.7);
      border-radius: var(--border-radius);
      backdrop-filter: blur(5px);
      padding: 0.25rem 0.75rem;
      line-height: 1.2;
      opacity: 0.8;
    }
    
    /* § Cognitive Header: Custom Cursor */
    .cursor {
      position: fixed;
      width: 24px;
      height: 24px;
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      pointer-events: none;
      z-index: 1000;
      mix-blend-mode: difference;
      transition: var(--transition-base);
      display: none;
    }
    
    /* § Cognitive Header: Overlay and Start Screen */
    .overlay {
      position: fixed;
      inset: 0;
      background: var(--color-overlay);
      display: grid;
      place-items: center;
      z-index: 100;
      backdrop-filter: blur(10px);
      cursor: pointer;
      user-select: none;
      pointer-events: auto;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
    }
    
    .overlay[hidden] {
      display: none;
    }
    
    .start-message {
      font-size: var(--font-size-large);
      font-weight: 300;
      color: var(--color-muted);
      text-align: center;
      animation: pulse 2s ease-in-out infinite;
      pointer-events: none;
      line-height: 1.3;
      padding: var(--space-md);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.9; }
      50% { opacity: 0.6; }
    }
    
    /* § Cognitive Header: YouTube Container */
    .youtube-container {
      position: fixed;
      top: -1000px;
      left: -1000px;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      z-index: -1;
    }
    
    /* § Cognitive Header: Responsive Design - Mobile First */
    @media (min-width: 768px) {
      :root {
        --font-size-base: 18px;
        --font-size-large: 28px;
        --space-md: 2rem;
        --space-lg: 2rem;
      }
      
      body {
        cursor: none;
      }
      
      .cursor {
        display: block;
      }
      
      .start-message {
        padding: 0;
      }
      
      .track-display {
        max-width: 350px;
      }
    }
    
    @media (max-width: 767px) {
      body {
        cursor: auto;
      }
      
      .overlay {
        padding: var(--space-md);
      }
      
      .start-message {
        font-size: clamp(18px, 6vw, 24px);
      }
      
      .now-playing {
        font-size: clamp(12px, 3vw, 14px);
        padding: 0.2rem 0.5rem;
      }
      
      .controls-hint {
        font-size: clamp(11px, 2.5vw, 13px);
        padding: 0.2rem 0.5rem;
      }
    }
    
    /* § Cognitive Header: Accessibility - High Contrast and Reduced Motion */
    @media (prefers-contrast: high) {
      canvas {
        filter: contrast(150%);
      }
      
      header, .now-playing, .controls-hint {
        text-shadow: 0 0 2px var(--color-bg);
      }
    }
    
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* § Cognitive Header: Focus Management */
    .overlay:focus {
      outline: 2px solid var(--color-focus);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <!-- § Cognitive Header: Accessibility Skip Link -->
  <a href="#canvas" class="skip-link">Skip to main content</a>
  
  <!-- § Cognitive Header: Main Visual Canvas -->
  <canvas id="canvas" role="img" aria-label="J Dilla sacred geometry visual experience"></canvas>
  
  <!-- § Cognitive Header: Site Header -->
  <header>
    <h1>radio.brgen.no</h1>
  </header>
  
  <!-- § Cognitive Header: Now Playing Display -->
  <div class="now-playing" id="now-playing" aria-live="polite">
    <span class="note-icon">♪</span>
    <span class="track-display" id="track-display">J Dilla - Microphone Master</span>
  </div>
  
  <!-- § Cognitive Header: Keyboard Controls Hint -->
  <div class="controls-hint" id="controls-hint">
    SPACE: pause • ← → : nav • HOME/END: jump
  </div>
  
  <!-- § Cognitive Header: Start Overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-labelledby="overlay-title" tabindex="0">
    <h2 id="overlay-title" style="display: none;">Start Audio Visualization</h2>
    <p class="start-message" aria-live="polite">Touch or click to start</p>
  </div>
  
  <!-- § Cognitive Header: Custom Cursor -->
  <div class="cursor" aria-hidden="true"></div>
  
  <!-- § Cognitive Header: YouTube Audio Container -->
  <div class="youtube-container">
    <iframe id="youtube-player" width="1" height="1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>
  
  <!-- § Cognitive Header: Modular JavaScript Architecture -->
  <script>
    // § Cognitive Header: Audio Engine Module
    class AudioEngine {
      constructor(onSongChange) {
        this.iframe = document.getElementById('youtube-player');
        this.isPlaying = false;
        this.isPaused = false;
        this.isReady = false;
        this.userInteracted = false;
        this.playbackFailed = false;
        this.retryCount = 0;
        this.maxRetries = 3;
        this.startTime = 0;
        this.pauseTime = 0;
        this.onSongChange = onSongChange;
        this.currentTrackIndex = 0;
        
        // § Cognitive Header: Track Playlist Data
        this.tracks = [
          { title: "Microphone Master [Extended]", id: "9EGHwkDix78", artist: "J Dilla" },
          { title: "Due Time", id: "WC09qDzU9y4", artist: "AFTA-1" },
          { title: "In Space", id: "9ycJsnzJ-hA", artist: "J Dilla" },
          { title: "Chinubian", id: "9OPypHXlJUQ", artist: "Jneiro Jarel" },
          { title: "Rhodes Ahead", id: "_-17rzyBrKY", artist: "Karriem Riggins" },
          { title: "Ooooaaa", id: "RpDcz90_oWY", artist: "Karriem Riggins" },
          { title: "Back In Brazil", id: "B1ZvmzfUJv0", artist: "Karriem Riggins" },
          { title: "Embryo", id: "JGUqRBJ4bIo", artist: "Baatin" },
          { title: "Orbitz", id: "nelU7OMF7VY", artist: "Karriem Riggins" },
          { title: "Sounds Like Love (Extended)", id: "jnP3tRG-LZs", artist: "J Dilla" },
          { title: "Get It Together (Instrumental)", id: "t6T-Q6HMbEo", artist: "J-88 (Slum Village)" },
          { title: "Hustle (Instrumental Mix)", id: "zoGTC7uROZE", artist: "J Dilla" },
          { title: "Stupid Lies (Instrumental) (HQ)", id: "7611GgbJAbM", artist: "J Dilla" },
          { title: "Fantastic (Instrumental)", id: "j0z_-7TfPeM", artist: "J Dilla" }
        ];
        
        this.playedModes = [];
        this.songDuration = 180000; // 3 minutes fallback
      }
      
      // § Cognitive Header: Random Song Selection
      randomSong() {
        return Math.floor(Math.random() * this.tracks.length);
      }
      
      // § Cognitive Header: Audio Control Methods
      start() {
        if (!this.userInteracted) return false;
        this.playTrack(this.currentTrackIndex);
        return true;
      }
      
      pause() {
        if (!this.isPlaying) return;
        this.isPaused = true;
        this.isPlaying = false;
        this.pauseTime = performance.now();
        // YouTube iframe doesn't allow direct pause, so we simulate
        this.iframe.src = '';
      }
      
      resume() {
        if (!this.isPaused) return;
        this.isPaused = false;
        this.isPlaying = true;
        this.startTime = performance.now() - (this.pauseTime - this.startTime);
        this.loadCurrentTrack();
      }
      
      togglePause() {
        if (this.isPaused) {
          this.resume();
        } else {
          this.pause();
        }
      }
      
      next() {
        this.currentTrackIndex = (this.currentTrackIndex + 1) % this.tracks.length;
        this.playTrack(this.currentTrackIndex);
      }
      
      previous() {
        this.currentTrackIndex = (this.currentTrackIndex - 1 + this.tracks.length) % this.tracks.length;
        this.playTrack(this.currentTrackIndex);
      }
      
      jumpToFirst() {
        this.currentTrackIndex = 0;
        this.playTrack(this.currentTrackIndex);
      }
      
      jumpToLast() {
        this.currentTrackIndex = this.tracks.length - 1;
        this.playTrack(this.currentTrackIndex);
      }
      
      setUserInteracted() {
        this.userInteracted = true;
      }
      
      // § Cognitive Header: Track Loading and Playback
      playTrack(index) {
        this.currentTrackIndex = index;
        this.retryCount = 0;
        this.isPaused = false;
        this.loadCurrentTrack();
        this.startTime = performance.now();
        this.updateTrackDisplay();
        if (this.onSongChange) this.onSongChange();
      }
      
      playNext() {
        this.currentTrackIndex = this.randomSong();
        this.playTrack(this.currentTrackIndex);
      }
      
      loadCurrentTrack() {
        if (this.retryCount >= this.maxRetries) {
          this.playbackFailed = true;
          document.getElementById('overlay').hidden = false;
          document.querySelector('.start-message').textContent = 'Click again to start audio';
          document.getElementById('track-display').textContent = 'Audio Failed: Click Canvas to Retry';
          return;
        }
        
        const track = this.tracks[this.currentTrackIndex];
        const embedUrl = `https://www.youtube.com/embed/${track.id}?autoplay=1&controls=0&disablekb=1&fs=0&iv_load_policy=3&modestbranding=1&playsinline=1&rel=0&showinfo=0&origin=${encodeURIComponent(window.location.origin)}`;
        
        try {
          this.iframe.src = embedUrl;
          this.isPlaying = true;
          this.isReady = true;
          
          // Auto-advance to next track
          setTimeout(() => {
            if (this.isPlaying && !this.isPaused) {
              this.playNext();
            }
          }, this.songDuration);
          
        } catch (error) {
          this.retryCount++;
          setTimeout(() => this.loadCurrentTrack(), 1000);
        }
      }
      
      // § Cognitive Header: Audio Analysis Simulation
      getAudioData() {
        if (!this.isPlaying || this.isPaused) {
          return { bass: 0, mid: 0, high: 0, average: 0 };
        }
        
        const time = (performance.now() - this.startTime) * 0.01;
        const bass = Math.abs(Math.sin(time * 0.8)) * 0.7 + 0.3;
        const mid = Math.abs(Math.cos(time * 1.2)) * 0.6 + 0.4;
        const high = Math.abs(Math.sin(time * 0.5)) * 0.8 + 0.2;
        
        return {
          bass,
          mid,
          high,
          average: (bass + mid + high) / 3
        };
      }
      
      updateTrackDisplay() {
        const track = this.tracks[this.currentTrackIndex];
        const displayEl = document.getElementById('track-display');
        if (displayEl) {
          displayEl.textContent = `${track.artist} - ${track.title}`;
        }
      }
      
      stop() {
        this.isPlaying = false;
        this.isPaused = false;
        this.iframe.src = '';
      }
    }
    
    // § Cognitive Header: Visualizer Mode Classes
    
    // § Warp Tunnel Mode
    class WarpTunnel {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.time = 0;
        this.particles = [];
        this.center = { x: 0, y: 0 };
        this.resize();
        this.initParticles();
      }
      
      resize() {
        this.w = window.innerWidth;
        this.h = window.innerHeight;
        this.center = { x: this.w / 2, y: this.h / 2 };
        this.canvas.width = this.w;
        this.canvas.height = this.h;
        this.initParticles();
      }
      
      initParticles() {
        this.particles = [];
        const rings = 70;
        const segments = 80;
        
        for (let i = 0; i < rings; i++) {
          const row = [];
          for (let j = 0; j < segments; j++) {
            row.push({
              z: i * 20,
              theta: (2 * Math.PI * j) / segments
            });
          }
          this.particles.push(row);
        }
      }
      
      update(audio) {
        this.time += 0.4 + audio.average * 0.15;
        
        // Clear with fade
        this.ctx.globalAlpha = 0.9;
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(0, 0, this.w, this.h);
        this.ctx.globalAlpha = 1.0;
        
        // Draw particles
        for (let i = 0; i < this.particles.length; i++) {
          for (let j = 0; j < this.particles[i].length; j++) {
            const p = this.particles[i][j];
            let z = (p.z + this.time * 120) % 1400;
            let scale = 500 / (z + 1);
            let r = 60 + i * 5 + Math.sin(this.time * 0.2 + j) * 6 * audio.bass;
            let x = this.center.x + Math.cos(p.theta + this.time * 0.01 + z * 0.0007) * r * scale;
            let y = this.center.y + Math.sin(p.theta + this.time * 0.01 + z * 0.0007) * r * scale;
            let hue = (200 + i * 2 + j * 4 + audio.mid * 130) % 360;
            let alpha = Math.max(0, 0.08 + 0.6 * scale);
            
            this.ctx.beginPath();
            this.ctx.arc(x, y, 1.5 + 1.5 * audio.high, 0, 2 * Math.PI);
            this.ctx.fillStyle = `hsla(${hue},90%,60%,${alpha})`;
            this.ctx.fill();
          }
        }
      }
    }
    
    // § Sacred Geometry Mandala Mode
    class Mandala {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.time = 0;
        this.resize();
      }
      
      resize() {
        this.w = window.innerWidth;
        this.h = window.innerHeight;
        this.cx = this.w / 2;
        this.cy = this.h / 2;
        this.canvas.width = this.w;
        this.canvas.height = this.h;
      }
      
      update(audio) {
        this.time += 0.008;
        
        // Clear with fade
        this.ctx.globalAlpha = 0.95;
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(0, 0, this.w, this.h);
        this.ctx.globalAlpha = 1;
        
        // Draw mandala layers
        for (let layer = 0; layer < 8; layer++) {
          let radius = 80 + layer * 50 + audio.bass * 90;
          let segments = 12 + layer * 8;
          
          this.ctx.save();
          this.ctx.translate(this.cx, this.cy);
          this.ctx.rotate(this.time * (layer % 2 === 0 ? 1 : -1) * (0.1 + audio.mid * 0.1));
          
          for (let i = 0; i < segments; i++) {
            let angle = (Math.PI * 2 * i) / segments;
            let x = Math.cos(angle) * radius;
            let y = Math.sin(angle) * radius;
            
            // Draw segment points
            this.ctx.beginPath();
            this.ctx.arc(x, y, 4 + audio.high * 10, 0, Math.PI * 2);
            this.ctx.fillStyle = `hsla(${200 + layer * 25 + audio.mid * 90},80%,60%,0.7)`;
            this.ctx.fill();
            
            // Golden ratio spirals
            this.ctx.beginPath();
            this.ctx.moveTo(0, 0);
            this.ctx.quadraticCurveTo(x * 0.618, y * 0.618, x, y);
            this.ctx.strokeStyle = `hsla(${160 + layer * 20},70%,50%,0.3)`;
            this.ctx.lineWidth = 1 + audio.average * 3;
            this.ctx.stroke();
          }
          
          this.ctx.restore();
        }
      }
    }
    
    // § Flower of Life Mode
    class FlowerOfLife {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.time = 0;
        this.resize();
      }
      
      resize() {
        this.w = window.innerWidth;
        this.h = window.innerHeight;
        this.cx = this.w / 2;
        this.cy = this.h / 2;
        this.canvas.width = this.w;
        this.canvas.height = this.h;
      }
      
      update(audio) {
        this.time += 0.006;
        
        // Clear with fade
        this.ctx.globalAlpha = 0.94;
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(0, 0, this.w, this.h);
        this.ctx.globalAlpha = 1;
        
        let levels = 6;
        
        for (let level = 0; level < levels; level++) {
          let scale = Math.pow(0.618, level); // Golden ratio scaling
          let radius = 140 * scale + audio.bass * 120 * scale;
          let circles = 6 + level * 3;
          
          this.ctx.save();
          this.ctx.translate(this.cx, this.cy);
          this.ctx.scale(scale, scale);
          this.ctx.rotate(this.time * 0.1 * (level % 2 === 0 ? 1 : -1));
          
          for (let i = 0; i < circles; i++) {
            let angle = (Math.PI * 2 * i) / circles;
            let x = Math.cos(angle) * radius;
            let y = Math.sin(angle) * radius;
            
            this.ctx.save();
            this.ctx.translate(x, y);
            this.ctx.rotate(angle + this.time * 0.15);
            
            // Outer circle
            this.ctx.beginPath();
            this.ctx.arc(0, 0, 30 + audio.high * 40, 0, Math.PI * 2);
            this.ctx.strokeStyle = `hsla(${120 + level * 40 + audio.mid * 120}, 80%, 60%, 0.4)`;
            this.ctx.lineWidth = 1 + audio.average * 2;
            this.ctx.stroke();
            
            // Inner petals
            for (let j = 0; j < 6; j++) {
              let innerAngle = (Math.PI * 2 * j) / 6;
              let innerRadius = 15 + audio.high * 20;
              let innerX = Math.cos(innerAngle) * innerRadius;
              let innerY = Math.sin(innerAngle) * innerRadius;
              
              this.ctx.beginPath();
              this.ctx.arc(innerX, innerY, 3 + audio.mid * 8, 0, Math.PI * 2);
              this.ctx.fillStyle = `hsla(${160 + level * 20 + j * 10}, 90%, 70%, 0.8)`;
              this.ctx.fill();
            }
            
            this.ctx.restore();
          }
          
          this.ctx.restore();
        }
      }
    }
    
    // § Parametric Lissajous Mesh Mode
    class LissajousMesh {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.time = 0;
        this.resize();
      }
      
      resize() {
        this.w = window.innerWidth;
        this.h = window.innerHeight;
        this.cx = this.w / 2;
        this.cy = this.h / 2;
        this.canvas.width = this.w;
        this.canvas.height = this.h;
      }
      
      update(audio) {
        this.time += 0.01;
        
        // Clear with fade
        this.ctx.globalAlpha = 0.96;
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(0, 0, this.w, this.h);
        this.ctx.globalAlpha = 1;
        
        let points = [];
        let N = 120;
        
        // Generate Lissajous curve points
        for (let i = 0; i < N; i++) {
          let a = 2 + audio.bass * 5;
          let b = 3 + audio.mid * 5;
          let t = (Math.PI * 2 * i) / N;
          let x = this.cx + Math.sin(a * t + this.time) * (this.w * 0.36 + Math.sin(this.time) * 30 * audio.high);
          let y = this.cy + Math.sin(b * t + this.time * 0.7) * (this.h * 0.36 + Math.cos(this.time) * 30 * audio.high);
          points.push({ x, y });
        }
        
        // Draw the curve
        this.ctx.beginPath();
        this.ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++) {
          this.ctx.lineTo(points[i].x, points[i].y);
        }
        this.ctx.closePath();
        
        this.ctx.strokeStyle = `hsla(${Math.abs(Math.sin(this.time) * 180) + audio.mid * 180}, 80%, 60%, 0.6)`;
        this.ctx.lineWidth = 2 + audio.bass * 5;
        this.ctx.shadowColor = `hsla(${Math.abs(Math.sin(this.time) * 180)},100%,70%,0.9)`;
        this.ctx.shadowBlur = 25 + audio.high * 30;
        this.ctx.stroke();
        this.ctx.shadowBlur = 0;
        
        // Draw sample points
        for (let i = 0; i < points.length; i += 4) {
          this.ctx.beginPath();
          this.ctx.arc(points[i].x, points[i].y, 3 + audio.high * 7, 0, Math.PI * 2);
          this.ctx.fillStyle = `hsla(${120 + i * 2 + audio.bass * 80}, 100%, 60%, 0.7)`;
          this.ctx.fill();
        }
      }
    }
    
    // § DMT Fractal Polygonal Tunnel Mode
    class DMTPolygonTunnel {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.time = 0;
        this.resize();
      }
      
      resize() {
        this.w = window.innerWidth;
        this.h = window.innerHeight;
        this.cx = this.w / 2;
        this.cy = this.h / 2;
        this.canvas.width = this.w;
        this.canvas.height = this.h;
      }
      
      update(audio) {
        this.time += 0.012;
        
        // Clear with fade
        this.ctx.globalAlpha = 0.9;
        this.ctx.fillStyle = "#000";
        this.ctx.fillRect(0, 0, this.w, this.h);
        this.ctx.globalAlpha = 1;
        
        let tunnelLayers = 20;
        
        for (let l = 0; l < tunnelLayers; l++) {
          let progress = l / tunnelLayers;
          let radius = (this.w + this.h) * 0.18 * (1 - progress * 0.7) + Math.sin(this.time * 0.8 + l) * 25 * audio.bass;
          let sides = 6 + Math.round(4 * audio.mid) + ((l % 2) ? 2 : 0);
          let hue = (this.time * 80 + l * 18 + audio.high * 120) % 360;
          
          this.ctx.save();
          this.ctx.translate(this.cx, this.cy);
          this.ctx.rotate(this.time * (progress * 1.2 + 0.4) + l * 0.15);
          
          this.ctx.beginPath();
          for (let i = 0; i < sides; i++) {
            let angle = (2 * Math.PI * i) / sides;
            let r = radius + Math.sin(angle * 6 + this.time * 2 + l * 0.4) * 15 * audio.high;
            let x = Math.cos(angle) * r;
            let y = Math.sin(angle) * r;
            
            if (i === 0) {
              this.ctx.moveTo(x, y);
            } else {
              this.ctx.lineTo(x, y);
            }
          }
          this.ctx.closePath();
          
          this.ctx.strokeStyle = `hsla(${hue},100%,65%,${0.18 + 0.14 * (1 - progress)})`;
          this.ctx.lineWidth = 2.5 + audio.bass * 6 * (1 - progress);
          this.ctx.shadowColor = `hsla(${hue},100%,75%,0.7)`;
          this.ctx.shadowBlur = 14 + audio.high * 25 * (1 - progress);
          this.ctx.stroke();
          this.ctx.shadowBlur = 0;
          
          this.ctx.restore();
        }
      }
    }
    
    // § Cognitive Header: Main Application Controller
    class SacredVisualizerApp {
      constructor() {
        this.canvas = document.getElementById('canvas');
        this.cursor = document.querySelector('.cursor');
        this.audioEngine = new AudioEngine(() => this.onSongChange());
        
        // § Visualizer modes array
        this.visualizerModes = [
          WarpTunnel,
          Mandala,
          FlowerOfLife,
          LissajousMesh,
          DMTPolygonTunnel
        ];
        
        this.modeHistory = [];
        this.currentModeIndex = Math.floor(Math.random() * this.visualizerModes.length);
        this.visualizer = new this.visualizerModes[this.currentModeIndex](this.canvas);
        
        this.isStarted = false;
        this.isMobile = window.innerWidth < 768 || 'ontouchstart' in window;
        
        this.setupEventListeners();
        this.animate();
      }
      
      // § Cognitive Header: Event Listeners Setup
      setupEventListeners() {
        const overlay = document.getElementById('overlay');
        let hasInteracted = false;
        
        // § Start experience function
        const startExperience = () => {
          if (hasInteracted) return;
          hasInteracted = true;
          this.audioEngine.setUserInteracted();
          this.audioEngine.start();
          overlay.hidden = true;
          this.isStarted = true;
        };
        
        // § Touch events for mobile
        if (this.isMobile || 'ontouchstart' in window) {
          overlay.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startExperience();
          }, { passive: false });
          
          document.addEventListener('touchstart', (e) => {
            if (!this.isStarted) return;
            e.preventDefault();
            const touch = e.touches[0];
            this.updateCursor(touch.clientX, touch.clientY);
          }, { passive: false });
          
          document.addEventListener('touchmove', (e) => {
            if (!this.isStarted) return;
            e.preventDefault();
            const touch = e.touches[0];
            this.updateCursor(touch.clientX, touch.clientY);
          }, { passive: false });
        }
        
        // § Mouse events
        overlay.addEventListener('click', startExperience);
        
        // § Keyboard events
        overlay.addEventListener('keydown', (e) => {
          if (['Enter', 'Space'].includes(e.code)) {
            e.preventDefault();
            startExperience();
          }
        });
        
        // § Global keyboard controls
        document.addEventListener('keydown', (e) => {
          if (!this.isStarted) return;
          
          switch (e.code) {
            case 'Space':
              e.preventDefault();
              this.audioEngine.togglePause();
              break;
            case 'ArrowRight':
              e.preventDefault();
              this.audioEngine.next();
              break;
            case 'ArrowLeft':
              e.preventDefault();
              this.audioEngine.previous();
              break;
            case 'Home':
              e.preventDefault();
              this.audioEngine.jumpToFirst();
              break;
            case 'End':
              e.preventDefault();
              this.audioEngine.jumpToLast();
              break;
          }
        });
        
        // § Mouse movement
        document.addEventListener('mousemove', (e) => {
          if (!this.isStarted) return;
          this.updateCursor(e.clientX, e.clientY);
        });
        
        // § Window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            this.visualizer.resize();
          }, 250);
        });
      }
      
      // § Cognitive Header: Cursor Update
      updateCursor(x, y) {
        if (!this.cursor || window.innerWidth < 768) return;
        
        this.cursor.style.left = x - 12 + 'px';
        this.cursor.style.top = y - 12 + 'px';
        this.cursor.style.transform = 'scale(1.1)';
        this.cursor.style.opacity = '0.8';
      }
      
      // § Cognitive Header: Song Change Handler
      onSongChange() {
        // Pick a new visualizer mode (no immediate repeats)
        let available = this.visualizerModes
          .map((_, i) => i)
          .filter(i => i !== this.currentModeIndex);
        
        if (available.length === 0) {
          available = [this.currentModeIndex];
        }
        
        const nextIndex = available[Math.floor(Math.random() * available.length)];
        this.currentModeIndex = nextIndex;
        this.visualizer = new this.visualizerModes[this.currentModeIndex](this.canvas);
        this.visualizer.resize();
      }
      
      // § Cognitive Header: Animation Loop
      animate() {
        const audioData = this.audioEngine.getAudioData();
        this.visualizer.update(audioData);
        requestAnimationFrame(() => this.animate());
      }
      
      // § Cognitive Header: Cleanup
      destroy() {
        this.audioEngine.stop();
      }
    }
    
    // § Cognitive Header: Application Initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        window.sacredApp = new SacredVisualizerApp();
      });
    } else {
      window.sacredApp = new SacredVisualizerApp();
    }
    
    // § Cognitive Header: Cleanup on Page Unload
    window.addEventListener('beforeunload', () => {
      if (window.sacredApp) {
        window.sacredApp.destroy();
      }
    });
  </script>
</body>
</html>